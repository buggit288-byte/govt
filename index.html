<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Karnataka Govt Staff Training (Simple)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-page: #f3f4f6;
      --bg-surface: #ffffff;
      --accent: #16a34a;
      --accent-soft: rgba(22, 163, 74, 0.08);
      --accent-strong: #15803d;
      --text-main: #111827;
      --text-soft: #6b7280;
      --border-soft: #e5e7eb;
      --danger: #ef4444;
      --radius-lg: 12px;
      --shadow-soft: 0 6px 20px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-page);
      color: var(--text-main);
      min-height: 100vh;
    }

    /* AUTH */

    .auth-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .auth-card {
      width: 100%;
      max-width: 360px;
      background: var(--bg-surface);
      border-radius: var(--radius-lg);
      padding: 16px 14px;
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
    }

    .auth-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .auth-logo {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: #16a34a;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.8rem;
    }

    .auth-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .auth-subtitle {
      font-size: 0.76rem;
      color: var(--text-soft);
    }

    .auth-tabs {
      display: flex;
      margin: 10px 0;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      overflow: hidden;
      font-size: 0.8rem;
    }

    .auth-tab {
      flex: 1;
      padding: 6px 0;
      text-align: center;
      cursor: pointer;
      background: #f9fafb;
      border: none;
      color: var(--text-soft);
    }

    .auth-tab.active {
      background: var(--accent);
      color: white;
      font-weight: 500;
    }

    .auth-form-group {
      margin-bottom: 8px;
      font-size: 0.8rem;
    }

    .auth-form-group label {
      display: block;
      margin-bottom: 2px;
      color: var(--text-soft);
    }

    .auth-input,
    .auth-select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 6px 9px;
      font-size: 0.82rem;
      outline: none;
    }

    .auth-input:focus,
    .auth-select:focus {
      border-color: var(--accent);
    }

    .auth-button {
      width: 100%;
      margin-top: 6px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: white;
      font-size: 0.84rem;
      font-weight: 500;
      padding: 7px 0;
      cursor: pointer;
    }

    .auth-error {
      margin-top: 6px;
      font-size: 0.78rem;
      color: var(--danger);
    }

    .auth-info {
      margin-top: 6px;
      font-size: 0.72rem;
      color: var(--text-soft);
    }

    /* APP LAYOUT */

    .app-wrapper {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border-soft);
      padding: 8px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .brand-logo {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: #16a34a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: white;
      font-weight: 700;
    }

    .brand-text-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .brand-text-subtitle {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .user-pill {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 3px 8px;
      background: #f9fafb;
      color: var(--text-main);
    }

    .btn-logout {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 3px 8px;
      background: #fee2e2;
      color: #b91c1c;
      font-size: 0.75rem;
      cursor: pointer;
    }

    /* NAV TABS */

    .top-nav {
      display: flex;
      gap: 8px;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border-soft);
      background: #f9fafb;
      font-size: 0.82rem;
      overflow-x: auto;
    }

    .nav-btn {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 5px 10px;
      background: white;
      cursor: pointer;
      white-space: nowrap;
      color: var(--text-soft);
    }

    .nav-btn.active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent-strong);
      font-weight: 500;
    }

    main {
      flex: 1;
      padding: 10px 12px 16px;
      max-width: 960px;
      width: 100%;
      margin: 0 auto;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .section-subtitle {
      font-size: 0.78rem;
      color: var(--text-soft);
      margin-bottom: 8px;
    }

    .card {
      background: var(--bg-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-soft);
      padding: 10px 10px 12px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 2px;
    }

    .card-subtitle {
      font-size: 0.76rem;
      color: var(--text-soft);
      margin-bottom: 6px;
    }

    .simple-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
    }

    .stat-box {
      background: #f9fafb;
      border-radius: 8px;
      padding: 8px;
      border: 1px solid var(--border-soft);
      font-size: 0.8rem;
    }

    .stat-label {
      color: var(--text-soft);
      margin-bottom: 2px;
    }

    .stat-value {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .big-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .big-btn {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 8px;
      text-align: center;
      font-size: 0.86rem;
      cursor: pointer;
      background: #f9fafb;
    }

    .big-btn:hover {
      background: #e5e7eb;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .btn-primary:hover {
      background: var(--accent-strong);
    }

    .progress-bar {
      margin-top: 6px;
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: #16a34a;
      transition: width 0.3s ease;
    }

    .attendance-row {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 0.76rem;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #f9fafb;
      cursor: pointer;
    }

    /* TRAINING */

    .field {
      margin-bottom: 8px;
      font-size: 0.8rem;
    }

    .field label {
      display: block;
      margin-bottom: 2px;
      color: var(--text-soft);
    }

    .field select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 6px 9px;
      font-size: 0.82rem;
    }

    ul.simple-list {
      margin-left: 18px;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    ul.simple-list li {
      margin-bottom: 4px;
    }

    /* PORTALS */

    .portal-item {
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      padding: 8px;
      margin-bottom: 6px;
      background: #f9fafb;
      font-size: 0.8rem;
    }

    .portal-item-title {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .portal-item-tagline {
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .portal-item-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    a.link {
      font-size: 0.78rem;
      color: var(--accent-strong);
      text-decoration: none;
    }

    a.link:hover {
      text-decoration: underline;
    }

    /* QUIZ */

    .quiz-question {
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      padding: 8px;
      margin-bottom: 6px;
      background: #f9fafb;
      font-size: 0.8rem;
    }

    .quiz-options label {
      display: block;
      margin-top: 3px;
    }

    .quiz-summary {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-top: 4px;
    }

    footer {
      text-align: center;
      font-size: 0.7rem;
      color: var(--text-soft);
      padding: 6px 8px 10px;
    }

    @media (max-width: 480px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-right {
        align-self: stretch;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <!-- AUTH -->
  <div id="authScreen" class="auth-screen">
    <div class="auth-card">
      <div class="auth-header">
        <div class="auth-logo">KG</div>
        <div>
          <div class="auth-title" id="authTitle">Login</div>
          <div class="auth-subtitle">Simple staff training portal (local data only).</div>
        </div>
      </div>

      <div class="auth-tabs">
        <button id="authTabLogin" class="auth-tab active">Login</button>
        <button id="authTabRegister" class="auth-tab">Register</button>
      </div>

      <form id="authForm">
        <div class="auth-form-group">
          <label for="authUsername">Username</label>
          <input id="authUsername" class="auth-input" required />
        </div>
        <div class="auth-form-group">
          <label for="authPassword">Password</label>
          <input id="authPassword" class="auth-input" type="password" required />
        </div>
        <div class="auth-form-group">
          <label for="authRole">Role (optional)</label>
          <select id="authRole" class="auth-select">
            <option value="staff">Staff</option>
            <option value="trainer">Trainer</option>
          </select>
        </div>
        <button type="submit" id="authSubmitBtn" class="auth-button">Login</button>
        <div id="authError" class="auth-error"></div>
        <div class="auth-info">
          All data is saved only in this browser using localStorage.  
          Use different usernames to simulate multiple staff.
        </div>
      </form>
    </div>
  </div>

  <!-- APP -->
  <div id="appWrapper" class="app-wrapper" style="display:none;">
    <header>
      <div class="brand">
        <div class="brand-logo">KG</div>
        <div>
          <div class="brand-text-title">Karnataka Staff Training</div>
          <div class="brand-text-subtitle">Basic portal · Seva Sindhu · Nadakacheri · Bhoomi · Sakala · RTO</div>
        </div>
      </div>
      <div class="header-right">
        <span>Logged in:</span>
        <span class="user-pill" id="headerUserName">user</span>
        <button class="btn-logout" id="btnLogout">Logout</button>
      </div>
    </header>

    <div class="top-nav">
      <button class="nav-btn active" data-section="dashboard">Dashboard</button>
      <button class="nav-btn" data-section="training">Training</button>
      <button class="nav-btn" data-section="quiz">Quiz</button>
      <button class="nav-btn" data-section="portals">Govt Portals</button>
    </div>

    <main>
      <!-- DASHBOARD -->
      <section id="section-dashboard" class="section active">
        <div class="section-title">Dashboard</div>
        <div class="section-subtitle" id="dashboardSubtitle">Loading...</div>

        <div class="card">
          <div class="card-title">Training progress</div>
          <div class="card-subtitle">Shows progress only for this logged-in user.</div>
          <div class="simple-grid">
            <div class="stat-box">
              <div class="stat-label">Modules completed</div>
              <div class="stat-value">
                <span id="statModulesCompleted">0</span>/<span id="statModulesTotal">0</span>
              </div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Best quiz score</div>
              <div class="stat-value" id="statBestScore">–</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Average quiz score</div>
              <div class="stat-value" id="statAvgScore">–</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Attendance days</div>
              <div class="stat-value" id="statAttendanceDays">0</div>
            </div>
          </div>
          <div class="progress-bar">
            <div id="overallProgressFill" class="progress-fill"></div>
          </div>

          <div class="attendance-row">
            <span id="attendanceMessage">Attendance not marked for today.</span>
            <button id="btnMarkAttendance" class="btn-small">Mark present today</button>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Quick actions</div>
          <div class="card-subtitle">Simple flow: Training → Quiz → Portals reference.</div>
          <div class="big-buttons">
            <button class="big-btn btn-primary" data-go="training">Go to Training</button>
            <button class="big-btn" data-go="quiz">Take Quiz</button>
            <button class="big-btn" data-go="portals">View Govt Portals</button>
          </div>
        </div>
      </section>

      <!-- TRAINING -->
      <section id="section-training" class="section">
        <div class="section-title">Training</div>
        <div class="section-subtitle">
          Choose a module and see simple objectives and steps. Marked as complete when you pass the quiz (≥70%).
        </div>

        <div class="card">
          <div class="field">
            <label for="trainingModuleSelect">Select module</label>
            <select id="trainingModuleSelect"></select>
          </div>
          <div id="trainingDetail">
            <div class="card-subtitle">Select a module to view details.</div>
          </div>
        </div>
      </section>

      <!-- QUIZ -->
      <section id="section-quiz" class="section">
        <div class="section-title">Quiz</div>
        <div class="section-subtitle">
          Short quiz for each module. Score ≥70% marks the module as completed.
        </div>

        <div class="card">
          <div class="field">
            <label for="quizModuleSelect">Quiz module</label>
            <select id="quizModuleSelect"></select>
          </div>
          <form id="quizForm">
            <div id="quizContainer"></div>
            <div style="margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <button type="submit" class="btn-small btn-primary">Submit answers</button>
              <div id="quizSummary" class="quiz-summary">No quiz taken yet.</div>
            </div>
          </form>
        </div>
      </section>

      <!-- PORTALS -->
      <section id="section-portals" class="section">
        <div class="section-title">Karnataka Govt Online Portals</div>
        <div class="section-subtitle">
          Use these official links while helping citizens. This page is only for reference.
        </div>

        <div id="portalList"></div>
      </section>
    </main>

    <footer>
      Karnataka Govt Staff Training · Simple front-end using only localStorage.  
      Extend later with real backend, central reports, and more modules.
    </footer>
  </div>

  <script>
    // -------- DATA --------

    const PORTALS = [
      {
        id: "seva-sindhu",
        name: "Seva Sindhu",
        url: "https://sevasindhu.karnataka.gov.in",
        tagline: "Single window for most Karnataka Government online services.",
        uses: "Certificates, pensions, labour services, transport integration"
      },
      {
        id: "nadakacheri",
        name: "Nadakacheri (AJR)",
        url: "https://nadakacheri.karnataka.gov.in",
        tagline: "Issue of Caste, Income, Residence and other certificates.",
        uses: "Caste, income, residence certificates"
      },
      {
        id: "bhoomi",
        name: "Bhoomi",
        url: "https://landrecords.karnataka.gov.in",
        tagline: "Land records: RTC / Pahani, mutation status.",
        uses: "RTC, mutation, land records"
      },
      {
        id: "sakala",
        name: "Sakala",
        url: "https://sakala.karnataka.gov.in",
        tagline: "Time-bound delivery of government services (Sakala Act).",
        uses: "Service timelines, GSC tracking, delay grievances"
      },
      {
        id: "rto",
        name: "Transport / RTO (Parivahan)",
        url: "https://parivahan.gov.in",
        tagline: "Driving licence, vehicle registration, tax payment.",
        uses: "LL, DL, RC, tax"
      }
    ];

    const MODULES = [
      {
        id: "income-cert-seva",
        title: "Income Certificate via Seva Sindhu",
        portal: "Seva Sindhu",
        level: "Beginner",
        duration: "30–40 min",
        objectives: [
          "Know basic eligibility and documents for income certificate.",
          "Open Seva Sindhu and select the correct income certificate service.",
          "Fill citizen details correctly and upload documents.",
          "Explain how to track status / download the certificate."
        ],
        steps: [
          "Open Seva Sindhu portal and choose 'Income Certificate'.",
          "Verify identity (Aadhaar / mobile OTP) if needed.",
          "Enter applicant details exactly as per ID proof.",
          "Type income details according to rules / self-declaration.",
          "Upload clear document scans.",
          "Submit, pay fee (if any) and note down Application/GSC no."
        ]
      },
      {
        id: "caste-cert-nadakacheri",
        title: "Caste Certificate via Nadakacheri",
        portal: "Nadakacheri",
        level: "Intermediate",
        duration: "40–60 min",
        objectives: [
          "Understand types of caste certificates (SC/ST/OBC).",
          "Use Nadakacheri portal to register the application.",
          "Know field enquiry and approval flow.",
          "Update citizens on status and re-application."
        ],
        steps: [
          "Open Nadakacheri portal and login.",
          "Choose the correct caste certificate service.",
          "Fill personal and family details carefully.",
          "Upload supporting records (old certificates, school records, ration card).",
          "Forward case for enquiry/approval as per SOP.",
          "Track status and contact citizen if more docs needed."
        ]
      },
      {
        id: "rtc-bhoomi",
        title: "RTC Download via Bhoomi",
        portal: "Bhoomi",
        level: "Beginner",
        duration: "20–30 min",
        objectives: [
          "Search land records by survey number or owner.",
          "Download RTC / Pahani.",
          "Explain important fields in RTC to citizens."
        ],
        steps: [
          "Open Bhoomi portal and go to RTC service.",
          "Select district, taluk, hobli, village.",
          "Search using survey number/account ID.",
          "Confirm land details with citizen.",
          "Download RTC, print or share as needed."
        ]
      },
      {
        id: "sakala-timelines",
        title: "Sakala Timelines & GSC Tracking",
        portal: "Sakala",
        level: "Beginner",
        duration: "25–35 min",
        objectives: [
          "Explain idea of Sakala (time-bound service).",
          "Find timeline for common services.",
          "Track an application using GSC number.",
          "Guide in case of delay."
        ],
        steps: [
          "Open Sakala portal and open service list/timelines.",
          "Search for department and service name.",
          "See allowed number of days for that service.",
          "Use GSC number to check current status.",
          "If delay, inform citizen about complaint options."
        ]
      },
      {
        id: "rto-basic-services",
        title: "Basics of RTO / Parivahan",
        portal: "Parivahan",
        level: "Intermediate",
        duration: "35–45 min",
        objectives: [
          "Know main RTO services (LL, DL, RC, tax).",
          "Open Parivahan and choose Karnataka services.",
          "Understand basic LL/DL application flow.",
          "Explain slot booking and payment steps."
        ],
        steps: [
          "Open Parivahan portal and choose state.",
          "View list of driving licence and vehicle services.",
          "Fill basic citizen details in sample form.",
          "Explain documents and slot booking for tests.",
          "Show where fee is paid and receipt is downloaded."
        ]
      }
    ];

    const QUIZZES = {
      "income-cert-seva": [
        {
          q: "Which portal is mainly used for Income Certificate applications?",
          options: ["Seva Sindhu", "Bhoomi", "Parivahan", "Khajane"],
          correctIndex: 0
        },
        {
          q: "What should staff always share with citizens after submitting an application?",
          options: [
            "Random number",
            "Only their own phone number",
            "Application / GSC number",
            "Nothing"
          ],
          correctIndex: 2
        }
      ],
      "caste-cert-nadakacheri": [
        {
          q: "Caste certificates in Karnataka are usually applied via:",
          options: ["Seva Sindhu", "Nadakacheri", "Parivahan", "Bhoomi"],
          correctIndex: 1
        },
        {
          q: "Field enquiry for caste certificate is done by:",
          options: ["Citizen", "Tahsildar/officials", "Bank", "School"],
          correctIndex: 1
        }
      ],
      "rtc-bhoomi": [
        {
          q: "RTC / Pahani details are available on which portal?",
          options: ["Parivahan", "Bhoomi", "Nadakacheri", "Sakala"],
          correctIndex: 1
        },
        {
          q: "RTC usually contains:",
          options: [
            "Electricity bill history",
            "Driving licence number",
            "Land owner and extent details",
            "Passport details"
          ],
          correctIndex: 2
        }
      ],
      "sakala-timelines": [
        {
          q: "Main purpose of Sakala is:",
          options: [
            "Collect taxes",
            "Issue passports",
            "Guarantee time-bound services",
            "Provide scholarships only"
          ],
          correctIndex: 2
        },
        {
          q: "Which number is used for tracking under Sakala?",
          options: ["PAN", "GSC", "Vehicle", "IFSC"],
          correctIndex: 1
        }
      ],
      "rto-basic-services": [
        {
          q: "Online RTO services are usually accessed using:",
          options: ["Bhoomi", "Parivahan", "Nadakacheri", "Seva Sindhu"],
          correctIndex: 1
        },
        {
          q: "LL and DL refer to:",
          options: [
            "Land Lease and Demarcation",
            "Learner’s Licence and Driving Licence",
            "Labour License and Department License",
            "Local List and District List"
          ],
          correctIndex: 1
        }
      ]
    };

    // -------- STORAGE --------

    const STORAGE_KEY_USERS = "kg_simple_users";
    const STORAGE_KEY_SESSION = "kg_simple_session";
    const STORAGE_KEY_TRAINING = "kg_simple_training";
    const STORAGE_KEY_ATTENDANCE = "kg_simple_attendance";

    function safeParse(json, fallback) {
      try {
        return json ? JSON.parse(json) : fallback;
      } catch {
        return fallback;
      }
    }

    function loadUsers() {
      return safeParse(localStorage.getItem(STORAGE_KEY_USERS), {});
    }

    function saveUsers(users) {
      localStorage.setItem(STORAGE_KEY_USERS, JSON.stringify(users));
    }

    function loadSession() {
      return safeParse(localStorage.getItem(STORAGE_KEY_SESSION), null);
    }

    function saveSession(session) {
      localStorage.setItem(STORAGE_KEY_SESSION, JSON.stringify(session));
    }

    const trainingState = safeParse(localStorage.getItem(STORAGE_KEY_TRAINING), {});
    function saveTrainingState() {
      localStorage.setItem(STORAGE_KEY_TRAINING, JSON.stringify(trainingState));
    }

    function getUserTraining(userId) {
      if (!trainingState[userId]) {
        trainingState[userId] = { moduleCompleted: {}, quizScores: {} };
      }
      return trainingState[userId];
    }

    const attendanceState = safeParse(localStorage.getItem(STORAGE_KEY_ATTENDANCE), {});
    function saveAttendanceState() {
      localStorage.setItem(STORAGE_KEY_ATTENDANCE, JSON.stringify(attendanceState));
    }

    function getUserAttendanceDates(userId) {
      const entry = attendanceState[userId] || {};
      return Object.keys(entry);
    }

    function markAttendanceToday(userId) {
      const today = new Date().toISOString().slice(0, 10);
      if (!attendanceState[userId]) attendanceState[userId] = {};
      attendanceState[userId][today] = true;
      saveAttendanceState();
    }

    // -------- STATE --------

    let currentUserId = null;
    let authMode = "login";
    let activeModuleId = MODULES[0]?.id || null;

    const authScreen = document.getElementById("authScreen");
    const appWrapper = document.getElementById("appWrapper");

    // -------- AUTH --------

    const authTabLogin = document.getElementById("authTabLogin");
    const authTabRegister = document.getElementById("authTabRegister");
    const authTitle = document.getElementById("authTitle");
    const authForm = document.getElementById("authForm");
    const authUsername = document.getElementById("authUsername");
    const authPassword = document.getElementById("authPassword");
    const authRole = document.getElementById("authRole");
    const authSubmitBtn = document.getElementById("authSubmitBtn");
    const authError = document.getElementById("authError");
    const headerUserName = document.getElementById("headerUserName");
    const btnLogout = document.getElementById("btnLogout");

    function setAuthMode(mode) {
      authMode = mode;
      authError.textContent = "";
      if (mode === "login") {
        authTabLogin.classList.add("active");
        authTabRegister.classList.remove("active");
        authTitle.textContent = "Login";
        authSubmitBtn.textContent = "Login";
      } else {
        authTabLogin.classList.remove("active");
        authTabRegister.classList.add("active");
        authTitle.textContent = "Register";
        authSubmitBtn.textContent = "Register";
      }
    }

    authTabLogin.addEventListener("click", () => setAuthMode("login"));
    authTabRegister.addEventListener("click", () => setAuthMode("register"));

    authForm.addEventListener("submit", (e) => {
      e.preventDefault();
      authError.textContent = "";
      const username = authUsername.value.trim();
      const password = authPassword.value;
      const role = authRole.value;

      if (!username || !password) {
        authError.textContent = "Enter username and password.";
        return;
      }

      const users = loadUsers();

      if (authMode === "register") {
        if (users[username]) {
          authError.textContent = "Username already exists.";
          return;
        }
        users[username] = { password, role };
        saveUsers(users);
        saveSession({ currentUser: username });
        startApp(username);
      } else {
        const user = users[username];
        if (!user || user.password !== password) {
          authError.textContent = "Invalid login.";
          return;
        }
        saveSession({ currentUser: username });
        startApp(username);
      }
    });

    btnLogout.addEventListener("click", () => {
      saveSession(null);
      currentUserId = null;
      appWrapper.style.display = "none";
      authScreen.style.display = "flex";
    });

    function startApp(username) {
      currentUserId = username;
      headerUserName.textContent = username;
      authScreen.style.display = "none";
      appWrapper.style.display = "flex";
      switchSection("dashboard");
      refreshDashboard();
      initTrainingDropdown();
      initQuizDropdown();
      renderQuiz();
      renderPortals();
      renderTrainingDetail(activeModuleId);
    }

    // -------- NAV / SECTIONS --------

    const sections = {
      dashboard: document.getElementById("section-dashboard"),
      training: document.getElementById("section-training"),
      quiz: document.getElementById("section-quiz"),
      portals: document.getElementById("section-portals")
    };

    function switchSection(key) {
      Object.entries(sections).forEach(([k, el]) => {
        el.classList.toggle("active", k === key);
      });
      document.querySelectorAll(".nav-btn").forEach(btn => {
        const sec = btn.getAttribute("data-section");
        btn.classList.toggle("active", sec === key);
      });
    }

    document.querySelectorAll(".nav-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const sec = btn.getAttribute("data-section");
        switchSection(sec);
        if (sec === "dashboard") refreshDashboard();
      });
    });

    document.querySelectorAll(".big-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-go");
        switchSection(target);
      });
    });

    // -------- DASHBOARD --------

    const overallProgressFill = document.getElementById("overallProgressFill");
    const statModulesCompleted = document.getElementById("statModulesCompleted");
    const statModulesTotal = document.getElementById("statModulesTotal");
    const statBestScore = document.getElementById("statBestScore");
    const statAvgScore = document.getElementById("statAvgScore");
    const statAttendanceDays = document.getElementById("statAttendanceDays");
    const dashboardSubtitle = document.getElementById("dashboardSubtitle");
    const attendanceMessage = document.getElementById("attendanceMessage");
    const btnMarkAttendance = document.getElementById("btnMarkAttendance");

    function refreshDashboard() {
      const uState = getUserTraining(currentUserId);
      const totalModules = MODULES.length;
      const completed = MODULES.filter(m => uState.moduleCompleted[m.id]).length;
      statModulesCompleted.textContent = completed;
      statModulesTotal.textContent = totalModules;

      const scores = Object.values(uState.quizScores).flat();
      let best = null, avg = null;
      if (scores.length > 0) {
        best = Math.max(...scores);
        avg = scores.reduce((a, b) => a + b, 0) / scores.length;
      }
      statBestScore.textContent = best === null ? "–" : best + "%";
      statAvgScore.textContent = avg === null ? "–" : avg.toFixed(1) + "%";

      const percent = totalModules ? Math.round((completed / totalModules) * 100) : 0;
      overallProgressFill.style.width = percent + "%";

      const dates = getUserAttendanceDates(currentUserId);
      const days = dates.length;
      statAttendanceDays.textContent = days;

      const today = new Date().toISOString().slice(0, 10);
      const hasToday = dates.includes(today);
      if (hasToday) {
        attendanceMessage.textContent = "Attendance already marked for today (" + today + ").";
        btnMarkAttendance.disabled = true;
        btnMarkAttendance.textContent = "Present marked";
      } else {
        attendanceMessage.textContent = "Attendance not marked for today.";
        btnMarkAttendance.disabled = false;
        btnMarkAttendance.textContent = "Mark present today";
      }

      dashboardSubtitle.textContent = `${currentUserId} · ${completed}/${totalModules} modules · ${percent}% complete · Attendance days: ${days}`;
    }

    btnMarkAttendance.addEventListener("click", () => {
      if (!currentUserId) return;
      markAttendanceToday(currentUserId);
      refreshDashboard();
    });

    // -------- TRAINING --------

    const trainingModuleSelect = document.getElementById("trainingModuleSelect");
    const trainingDetail = document.getElementById("trainingDetail");

    function initTrainingDropdown() {
      trainingModuleSelect.innerHTML = "";
      MODULES.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m.id;
        opt.textContent = m.title;
        trainingModuleSelect.appendChild(opt);
      });
      if (activeModuleId) trainingModuleSelect.value = activeModuleId;
      trainingModuleSelect.addEventListener("change", () => {
        activeModuleId = trainingModuleSelect.value;
        renderTrainingDetail(activeModuleId);
      });
    }

    function renderTrainingDetail(moduleId) {
      const m = MODULES.find(x => x.id === moduleId);
      if (!m) {
        trainingDetail.innerHTML = '<div class="card-subtitle">Select a module to view details.</div>';
        return;
      }
      const objectivesHtml = m.objectives.map(o => `<li>${o}</li>`).join("");
      const stepsHtml = m.steps.map(s => `<li>${s}</li>`).join("");

      const uState = getUserTraining(currentUserId);
      const done = !!uState.moduleCompleted[m.id];

      trainingDetail.innerHTML = `
        <div class="card-title">${m.title}</div>
        <div class="card-subtitle">${m.portal} · ${m.level} · ${m.duration}</div>
        <div style="font-size:0.78rem; margin-bottom:4px;">
          Status: <strong>${done ? "Completed (quiz passed)" : "Not completed yet"}</strong>
        </div>
        <div style="margin-bottom:6px;">
          <strong style="font-size:0.8rem;">Objectives:</strong>
          <ul class="simple-list">${objectivesHtml}</ul>
        </div>
        <div>
          <strong style="font-size:0.8rem;">Steps:</strong>
          <ul class="simple-list">${stepsHtml}</ul>
        </div>
      `;
    }

    // -------- PORTALS --------

    const portalList = document.getElementById("portalList");
    function renderPortals() {
      portalList.innerHTML = "";
      PORTALS.forEach(p => {
        const div = document.createElement("div");
        div.className = "portal-item";
        div.innerHTML = `
          <div class="portal-item-title">${p.name}</div>
          <div class="portal-item-tagline">${p.tagline}</div>
          <div style="font-size:0.76rem; color:${'var(--text-soft)'};">Key uses: ${p.uses}</div>
          <div class="portal-item-footer" style="margin-top:4px;">
            <span style="font-size:0.76rem;">Official site:</span>
            <a class="link" href="${p.url}" target="_blank" rel="noopener noreferrer">${p.url}</a>
          </div>
        `;
        portalList.appendChild(div);
      });
    }

    // -------- QUIZ --------

    const quizModuleSelect = document.getElementById("quizModuleSelect");
    const quizContainer = document.getElementById("quizContainer");
    const quizSummary = document.getElementById("quizSummary");
    const quizForm = document.getElementById("quizForm");

    function initQuizDropdown() {
      quizModuleSelect.innerHTML = "";
      MODULES.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m.id;
        opt.textContent = m.title;
        quizModuleSelect.appendChild(opt);
      });
      if (activeModuleId) {
        quizModuleSelect.value = activeModuleId;
      }
      quizModuleSelect.addEventListener("change", () => {
        activeModuleId = quizModuleSelect.value;
        renderQuiz();
      });
    }

    function renderQuiz() {
      const modId = activeModuleId || MODULES[0]?.id;
      if (!modId) {
        quizContainer.innerHTML = "<div class='card-subtitle'>No modules configured.</div>";
        quizSummary.textContent = "No quiz.";
        return;
      }
      activeModuleId = modId;
      if (quizModuleSelect.value !== modId) quizModuleSelect.value = modId;

      const questions = QUIZZES[modId] || [];
      if (!questions.length) {
        quizContainer.innerHTML = "<div class='card-subtitle'>No quiz for this module yet.</div>";
        quizSummary.textContent = "Trainer can add quiz questions later.";
        return;
      }

      quizContainer.innerHTML = "";
      questions.forEach((q, idx) => {
        const div = document.createElement("div");
        div.className = "quiz-question";
        let optsHtml = "";
        q.options.forEach((opt, i) => {
          const id = `q${idx}_opt${i}`;
          optsHtml += `
            <label for="${id}">
              <input type="radio" name="q${idx}" id="${id}" value="${i}" />
              ${opt}
            </label>
          `;
        });
        div.innerHTML = `<div><strong>Q${idx + 1}.</strong> ${q.q}</div>
                         <div class="quiz-options">${optsHtml}</div>`;
        quizContainer.appendChild(div);
      });

      const uState = getUserTraining(currentUserId);
      const scores = uState.quizScores[modId] || [];
      if (scores.length) {
        const last = scores[scores.length - 1];
        const best = Math.max(...scores);
        quizSummary.innerHTML = `Last score: <strong>${last}%</strong> · Best: <strong>${best}%</strong>`;
      } else {
        quizSummary.textContent = "No quiz attempts yet for this module.";
      }
    }

    quizForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const modId = activeModuleId;
      const questions = QUIZZES[modId] || [];
      if (!questions.length) return;

      let correct = 0;
      const unanswered = [];
      questions.forEach((q, idx) => {
        const sel = document.querySelector(`input[name="q${idx}"]:checked`);
        if (!sel) {
          unanswered.push(idx + 1);
          return;
        }
        const value = parseInt(sel.value, 10);
        if (value === q.correctIndex) correct++;
      });

      if (unanswered.length) {
        quizSummary.textContent = "Please answer all questions (missing: " + unanswered.join(", ") + ").";
        return;
      }

      const score = Math.round((correct / questions.length) * 100);
      const uState = getUserTraining(currentUserId);
      if (!uState.quizScores[modId]) uState.quizScores[modId] = [];
      uState.quizScores[modId].push(score);

      if (score >= 70) {
        uState.moduleCompleted[modId] = true;
      }
      saveTrainingState();

      quizSummary.innerHTML = `You scored <strong>${score}%</strong> (${correct}/${questions.length}). ` +
        (score >= 70 ? "Module marked as completed." : "Score ≥70% needed to mark as completed.");
      renderTrainingDetail(modId);
      refreshDashboard();
    });

    // -------- INIT --------

    (function init() {
      const session = loadSession();
      if (session && session.currentUser) {
        startApp(session.currentUser);
      } else {
        authScreen.style.display = "flex";
      }
    })();
  </script>
</body>
</html>
